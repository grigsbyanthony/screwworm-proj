# Complete Functional Characterization with PICRUSt2 Description Files
# Updated to use description files generated by add_descriptions.py

library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(pheatmap)
library(gridExtra)
library(knitr)
library(DT)

# Set working directory to your PICRUSt2 output folder
# setwd("path/to/your/picrust2_output")

# ============================================================================
# 1. LOAD PICRUST2 DATA WITH DESCRIPTIONS
# ============================================================================

# Function to load PICRUSt2 data with descriptions
load_picrust_with_descriptions <- function(file_path, description) {
  if(file.exists(file_path)) {
    cat("Loading", description, "from", file_path, "\n")
    data <- read.table(file_path, header = TRUE, sep = "\t", check.names = FALSE, quote = "")
    cat("Dimensions:", nrow(data), "features x", ncol(data), "columns\n")
    
    # Check if description column exists
    if("description" %in% colnames(data)) {
      cat("Description column found!\n")
    } else {
      cat("No description column found\n")
    }
    cat("\n")
    return(data)
  } else {
    cat("Warning:", file_path, "not found. Skipping", description, "\n")
    return(NULL)
  }
}

# Load pathway data with descriptions
pathway_descrip <- load_picrust_with_descriptions("pathways_out/path_abun_unstrat_descrip.tsv.gz", 
                                                  "pathway abundances with descriptions")

# Load KO data with descriptions
ko_descrip <- load_picrust_with_descriptions("KO_metagenome_out/pred_metagenome_unstrat_descrip.tsv.gz", 
                                             "KO abundances with descriptions")

# Load EC data with descriptions  
ec_descrip <- load_picrust_with_descriptions("EC_metagenome_out/pred_metagenome_unstrat_descrip.tsv.gz", 
                                             "EC abundances with descriptions")

# Check structure of pathway data
if(!is.null(pathway_descrip)) {
  cat("=== PATHWAY DATA STRUCTURE ===\n")
  cat("Column names:\n")
  print(head(colnames(pathway_descrip), 10))
  cat("First few rows:\n")
  print(pathway_descrip[1:3, 1:5])
  cat("\n")
}

# ============================================================================
# 2. EXTRACT ABUNDANCE DATA AND DESCRIPTIONS
# ============================================================================

# Function to separate abundance data from descriptions
extract_abundance_and_descriptions <- function(data_with_desc, data_name) {
  if(is.null(data_with_desc)) return(list(abundance = NULL, descriptions = NULL))
  
  # Find description column
  desc_col <- which(colnames(data_with_desc) == "description")
  
  if(length(desc_col) > 0) {
    # Extract descriptions
    descriptions <- data_with_desc[, c(1, desc_col)] 
    colnames(descriptions) <- c("feature", "description")
    
    # Extract abundance data (all columns except description)
    abundance_data <- data_with_desc[, -desc_col]
    rownames(abundance_data) <- abundance_data[, 1]
    abundance_data <- abundance_data[, -1]  # Remove first column (feature names)
    
    cat(paste("Extracted", data_name, "- Abundance matrix:", nrow(abundance_data), "x", ncol(abundance_data), "\n"))
    cat(paste("Extracted", data_name, "- Descriptions:", nrow(descriptions), "entries\n"))
    
  } else {
    # No description column, treat as abundance data only
    abundance_data <- data_with_desc
    rownames(abundance_data) <- abundance_data[, 1]
    abundance_data <- abundance_data[, -1]
    descriptions <- data.frame(feature = rownames(abundance_data), 
                              description = paste("No description available"))
  }
  
  # Clean sample names
  colnames(abundance_data) <- gsub("^X", "", colnames(abundance_data))
  
  return(list(abundance = abundance_data, descriptions = descriptions))
}

# Extract pathway data
pathway_data <- extract_abundance_and_descriptions(pathway_descrip, "pathways")
pathway_abundance <- pathway_data$abundance
pathway_descriptions <- pathway_data$descriptions

# Extract KO data
ko_data <- extract_abundance_and_descriptions(ko_descrip, "KO functions")
ko_abundance <- ko_data$abundance
ko_descriptions <- ko_data$descriptions

# Extract EC data
ec_data <- extract_abundance_and_descriptions(ec_descrip, "EC functions")
ec_abundance <- ec_data$abundance
ec_descriptions <- ec_data$descriptions

# ============================================================================
# 3. PATHWAY ABUNDANCE ANALYSIS WITH DESCRIPTIONS
# ============================================================================

if(!is.null(pathway_abundance)) {
  cat("=== ANALYZING PATHWAY DATA ===\n")
  cat("Samples:", paste(colnames(pathway_abundance), collapse = ", "), "\n\n")
  
  # Calculate pathway statistics
  pathway_summary <- pathway_abundance %>%
    rownames_to_column("pathway") %>%
    rowwise() %>%
    mutate(
      mean_abundance = mean(c_across(where(is.numeric))),
      max_abundance = max(c_across(where(is.numeric))),
      median_abundance = median(c_across(where(is.numeric))),
      prevalence = sum(c_across(where(is.numeric)) > 0),
      prevalence_pct = (prevalence / ncol(pathway_abundance)) * 100
    ) %>%
    ungroup() %>%
    arrange(desc(mean_abundance))
  
  # Add descriptions
  pathway_summary <- pathway_summary %>%
    left_join(pathway_descriptions, by = c("pathway" = "feature"))
  
  # Improved functional categorization using descriptions
  pathway_summary <- pathway_summary %>%
    mutate(
      description_lower = tolower(description),
      category = case_when(
        # Energy metabolism
        grepl("glycolysis|gluconeogenesis|pentose phosphate|entner", description_lower) ~ "Energy Metabolism",
        grepl("tca cycle|citric acid|tricarboxylic|krebs", description_lower) ~ "Energy Metabolism", 
        grepl("fermentation|anaerobic", description_lower) ~ "Fermentation",
        grepl("respiration|electron transport|oxidative phosphorylation", description_lower) ~ "Respiration",
        
        # Biosynthesis pathways
        grepl("biosynthesis|synthesis", description_lower) & 
          !grepl("degradation", description_lower) ~ "Biosynthesis",
        grepl("fatty acid.*biosynthesis|lipid.*biosynthesis", description_lower) ~ "Lipid Biosynthesis",
        grepl("amino acid.*biosynthesis|protein.*biosynthesis", description_lower) ~ "Amino Acid Biosynthesis", 
        grepl("nucleotide.*biosynthesis|purine.*biosynthesis|pyrimidine.*biosynthesis", description_lower) ~ "Nucleotide Biosynthesis",
        grepl("peptidoglycan.*biosynthesis|cell wall.*biosynthesis", description_lower) ~ "Cell Wall Biosynthesis",
        grepl("vitamin.*biosynthesis|cofactor.*biosynthesis|coenzyme.*biosynthesis", description_lower) ~ "Cofactor/Vitamin Biosynthesis",
        
        # Degradation pathways
        grepl("degradation|catabolism", description_lower) ~ "Degradation",
        grepl("fatty acid.*degradation|lipid.*degradation", description_lower) ~ "Lipid Degradation",
        grepl("amino acid.*degradation|protein.*degradation", description_lower) ~ "Amino Acid Degradation",
        
        # Specific metabolic categories
        grepl("carbohydrate|glucose|fructose|galactose|mannose|sucrose", description_lower) ~ "Carbohydrate Metabolism",
        grepl("aromatic|phenyl|benzoate|tryptophan|tyrosine|phenylalanine", description_lower) ~ "Aromatic Compound Metabolism",
        grepl("sulfur|sulfate|cysteine|methionine", description_lower) ~ "Sulfur Metabolism",
        grepl("nitrogen|nitrate|nitrite|ammonia", description_lower) ~ "Nitrogen Metabolism",
        grepl("folate|tetrahydrofolate|one-carbon", description_lower) ~ "One-Carbon Metabolism",
        grepl("menaquinone|ubiquinone|quinone|vitamin k", description_lower) ~ "Quinone/Vitamin K Metabolism",
        
        # Salvage pathways
        grepl("salvage|recycling", description_lower) ~ "Salvage Pathways",
        
        # Default
        TRUE ~ "Other Metabolic Pathways"
      )
    )
  
  # Display results
  cat("=== TOP 20 MOST ABUNDANT PATHWAYS ===\n")
  top_pathways <- pathway_summary %>%
    select(pathway, description, mean_abundance, prevalence_pct, category) %>%
    head(20)
  print(kable(top_pathways, digits = 2))
  
  # Category summary
  category_summary <- pathway_summary %>%
    group_by(category) %>%
    summarise(
      pathway_count = n(),
      total_abundance = sum(mean_abundance),
      avg_abundance = mean(mean_abundance),
      avg_prevalence = mean(prevalence_pct),
      .groups = "drop"
    ) %>%
    arrange(desc(total_abundance))
  
  cat("\n=== FUNCTIONAL CATEGORY SUMMARY ===\n")
  print(kable(category_summary, digits = 2))
}

# ============================================================================
# 4. VISUALIZATION WITH DESCRIPTIONS
# ============================================================================

if(!is.null(pathway_summary)) {
  
  # 1. Top 30 pathways with descriptions
  top30_plot <- pathway_summary %>%
    head(30) %>%
    mutate(short_description = ifelse(nchar(description) > 60, 
                                     paste0(substr(description, 1, 57), "..."), 
                                     description)) %>%
    ggplot(aes(x = reorder(short_description, mean_abundance), y = mean_abundance)) +
    geom_col(fill = "steelblue", alpha = 0.7) +
    coord_flip() +
    labs(title = "Top 30 Most Abundant Pathways",
         subtitle = "Cochliomyia macellaria endogenous microbiota functional capacity",
         x = "Pathway Description",
         y = "Mean Abundance") +
    theme_bw() +
    theme(axis.text.y = element_text(size = 7),
          plot.title = element_text(size = 14, face = "bold"))
  
  print(top30_plot)
  
  # 2. Functional category abundance
  category_plot <- ggplot(category_summary, aes(x = reorder(category, total_abundance), 
                                                y = total_abundance)) +
    geom_col(aes(fill = category), alpha = 0.8, show.legend = FALSE) +
    coord_flip() +
    scale_fill_brewer(type = "qual", palette = "Set3") +
    labs(title = "Functional Category Distribution", 
         subtitle = "Total abundance by metabolic category",
         x = "Functional Category",
         y = "Total Abundance") +
    theme_bw() +
    theme(axis.text.y = element_text(size = 9))
  
  print(category_plot)
  
  # 3. Category diversity (number of pathways vs total abundance)
  diversity_plot <- ggplot(category_summary, aes(x = pathway_count, y = total_abundance)) +
    geom_point(aes(size = avg_prevalence, color = category), alpha = 0.7) +
    geom_text(aes(label = category), hjust = 0, vjust = 0, size = 3, nudge_x = 0.5) +
    scale_size_continuous(name = "Avg Prevalence (%)", range = c(2, 8)) +
    labs(title = "Functional Category Diversity vs Abundance",
         subtitle = "Bubble size = average prevalence",
         x = "Number of Pathways",
         y = "Total Abundance") +
    theme_bw() +
    theme(legend.position = "bottom")
  
  print(diversity_plot)
  
  # 4. Prevalence vs abundance scatter
  prevalence_plot <- ggplot(pathway_summary, aes(x = prevalence_pct, y = log10(mean_abundance + 1))) +
    geom_point(aes(color = category), alpha = 0.6) +
    labs(title = "Pathway Prevalence vs Abundance",
         subtitle = "Each point represents one metabolic pathway",
         x = "Prevalence (% of samples)",
         y = "Log10(Mean Abundance + 1)",
         color = "Functional Category") +
    theme_bw() +
    theme(legend.position = "right",
          legend.text = element_text(size = 8))
  
  print(prevalence_plot)
  
  # 5. Prevalence vs abundance area plot - completely revised approach
  cat("\nCreating prevalence vs abundance area plot...\n")
  
  # First, examine the prevalence distribution
  cat("Prevalence distribution summary:\n")
  prevalence_summary <- summary(pathway_summary$prevalence_pct)
  print(prevalence_summary)
  
  # Check for NA values
  na_count <- sum(is.na(pathway_summary$prevalence_pct))
  cat("Number of NA values in prevalence_pct:", na_count, "\n\n")
  
  # Create a continuous version using geom_area with continuous x-axis
  # Prepare data by sorting pathways by prevalence
  area_data_continuous <- pathway_summary %>%
    # Remove any NA values
    filter(!is.na(prevalence_pct)) %>%
    # Sort by prevalence
    arrange(prevalence_pct) %>%
    # Add row number for x-axis ordering
    mutate(order_index = row_number()) %>%
    # Select needed columns
    select(pathway, prevalence_pct, mean_abundance, category, order_index)
  
  # Print summary of the prepared data
  cat("Continuous data summary:\n")
  cat("- Number of pathways:", nrow(area_data_continuous), "\n")
  cat("- Number of categories:", length(unique(area_data_continuous$category)), "\n")
  cat("- Prevalence range:", min(area_data_continuous$prevalence_pct), "to", 
      max(area_data_continuous$prevalence_pct), "\n")
  cat("- Total abundance sum:", sum(area_data_continuous$mean_abundance), "\n\n")
  
  # Create a true area plot with continuous x-axis
  area_plot_continuous <- ggplot(area_data_continuous, 
                                aes(x = prevalence_pct, y = mean_abundance, fill = category)) +
    # Use geom_area with continuous x-axis
    geom_area(stat = "smooth", method = "loess", span = 0.2, alpha = 0.8) +
    scale_fill_brewer(palette = "Set3", name = "Functional Category") +
    labs(title = "Pathway Abundance Distribution by Prevalence",
         subtitle = "Area shows contribution of each functional category across prevalence spectrum",
         x = "Prevalence (%)",
         y = "Mean Abundance") +
    theme_bw() +
    theme(legend.position = "right",
          legend.text = element_text(size = 8))
  
  # Print the continuous area plot
  print(area_plot_continuous)
  
  # Save the continuous area plot
  ggsave("complete_functional_analysis/prevalence_vs_abundance_area.png", 
         area_plot_continuous, width = 12, height = 8, dpi = 300)
  
  # Also create a scatter plot with smoothed lines by category
  scatter_plot <- ggplot(area_data_continuous, 
                        aes(x = prevalence_pct, y = mean_abundance, color = category)) +
    # Add points
    geom_point(alpha = 0.3, size = 1) +
    # Add smoothed lines
    geom_smooth(method = "loess", se = FALSE, span = 0.5, linewidth = 1.2) +
    scale_color_brewer(palette = "Set3", name = "Functional Category") +
    labs(title = "Pathway Abundance vs Prevalence by Category",
         subtitle = "Smoothed trends show abundance patterns across prevalence spectrum",
         x = "Prevalence (%)",
         y = "Mean Abundance") +
    theme_bw() +
    theme(legend.position = "right",
          legend.text = element_text(size = 8))
  
  # Print the scatter plot
  print(scatter_plot)
  
  # Save the scatter plot too
  ggsave("complete_functional_analysis/prevalence_vs_abundance_scatter.png", 
         scatter_plot, width = 12, height = 8, dpi = 300)
}

# ============================================================================
# 5. DETAILED FUNCTIONAL ANALYSIS BY CATEGORY
# ============================================================================

if(!is.null(pathway_summary)) {
  cat("\n=== DETAILED ANALYSIS BY FUNCTIONAL CATEGORY ===\n")
  
  # Function to analyze each category in detail
  analyze_category_detailed <- function(cat_name, top_n = 10) {
    cat("\n", paste(rep("=", 50), collapse = ""), "\n")
    cat(toupper(cat_name), "\n")
    cat(paste(rep("=", 50), collapse = ""), "\n")
    
    cat_data <- pathway_summary %>%
      filter(category == cat_name) %>%
      arrange(desc(mean_abundance))
    
    if(nrow(cat_data) > 0) {
      cat("Number of pathways:", nrow(cat_data), "\n")
      cat("Total category abundance:", round(sum(cat_data$mean_abundance), 2), "\n")
      cat("Average pathway abundance:", round(mean(cat_data$mean_abundance), 2), "\n")
      cat("Most prevalent pathway:", round(max(cat_data$prevalence_pct), 1), "% prevalence\n\n")
      
      cat("Top", min(top_n, nrow(cat_data)), "pathways in this category:\n")
      top_cat <- cat_data %>%
        head(top_n) %>%
        select(pathway, description, mean_abundance, prevalence_pct)
      
      print(kable(top_cat, digits = 2))
    } else {
      cat("No pathways found in this category.\n")
    }
  }
  
  # Analyze top 5 categories
  for(cat in category_summary$category[1:min(5, nrow(category_summary))]) {
    analyze_category_detailed(cat)
  }
}

# ============================================================================
# 6. EXPORT COMPREHENSIVE RESULTS
# ============================================================================

# Create results directory
dir.create("complete_functional_analysis", showWarnings = FALSE)

if(!is.null(pathway_summary)) {
  # Export pathway results
  write.csv(pathway_summary, 
            "complete_functional_analysis/pathway_analysis_with_descriptions.csv", 
            row.names = FALSE)
  
  write.csv(category_summary, 
            "complete_functional_analysis/functional_category_summary.csv", 
            row.names = FALSE)
  
  # Export detailed category breakdowns
  for(cat in unique(pathway_summary$category)) {
    cat_data <- pathway_summary %>%
      filter(category == cat) %>%
      arrange(desc(mean_abundance))
    
    safe_name <- gsub("[^A-Za-z0-9]", "_", cat)
    filename <- paste0("complete_functional_analysis/", safe_name, "_detailed.csv")
    write.csv(cat_data, filename, row.names = FALSE)
  }
  
  # Save plots
  ggsave("complete_functional_analysis/top30_pathways_described.png", 
         top30_plot, width = 14, height = 12, dpi = 300)
  ggsave("complete_functional_analysis/functional_categories.png", 
         category_plot, width = 12, height = 8, dpi = 300)
  ggsave("complete_functional_analysis/category_diversity.png", 
         diversity_plot, width = 12, height = 8, dpi = 300)
  ggsave("complete_functional_analysis/prevalence_vs_abundance.png", 
         prevalence_plot, width = 12, height = 8, dpi = 300)
}

# Export KO and EC summaries if available
if(!is.null(ko_abundance)) {
  ko_summary <- ko_abundance %>%
    rownames_to_column("ko") %>%
    rowwise() %>%
    mutate(mean_abundance = mean(c_across(where(is.numeric)))) %>%
    ungroup() %>%
    left_join(ko_descriptions, by = c("ko" = "feature")) %>%
    arrange(desc(mean_abundance))
  
  write.csv(ko_summary, "complete_functional_analysis/ko_analysis_with_descriptions.csv", row.names = FALSE)
}

if(!is.null(ec_abundance)) {
  ec_summary <- ec_abundance %>%
    rownames_to_column("ec") %>%
    rowwise() %>%
    mutate(mean_abundance = mean(c_across(where(is.numeric)))) %>%
    ungroup() %>%
    left_join(ec_descriptions, by = c("ec" = "feature")) %>%
    arrange(desc(mean_abundance))
  
  write.csv(ec_summary, "complete_functional_analysis/ec_analysis_with_descriptions.csv", row.names = FALSE)
}

# ============================================================================
# 7. SUMMARY REPORT
# ============================================================================

if(!is.null(pathway_summary)) {
  # Create comprehensive summary
  total_pathways <- nrow(pathway_summary)
  universal_pathways <- sum(pathway_summary$prevalence_pct == 100)
  core_pathways <- sum(pathway_summary$prevalence_pct >= 75)
  top_category <- category_summary$category[1]
  top_pathway <- pathway_summary$description[1]
  
  summary_text <- paste0(
    "FUNCTIONAL CHARACTERIZATION SUMMARY\n",
    "Cochliomyia macellaria Endogenous Microbiota\n",
    "==========================================\n\n",
    "DATASET OVERVIEW:\n",
    "- Samples analyzed: ", ncol(pathway_abundance), "\n",
    "- Total metabolic pathways detected: ", total_pathways, "\n",
    "- Universal pathways (100% prevalence): ", universal_pathways, "\n",
    "- Core pathways (≥75% prevalence): ", core_pathways, "\n\n",
    "FUNCTIONAL CAPACITY:\n",
    "- Dominant functional category: ", top_category, "\n",
    "- Most abundant pathway: ", top_pathway, "\n",
    "- Number of functional categories: ", nrow(category_summary), "\n\n",
    "TOP 5 FUNCTIONAL CATEGORIES BY ABUNDANCE:\n",
    paste(paste(1:min(5, nrow(category_summary)), 
                category_summary$category[1:min(5, nrow(category_summary))], 
                paste0("(", category_summary$pathway_count[1:min(5, nrow(category_summary))], " pathways, ",
                       round(category_summary$total_abundance[1:min(5, nrow(category_summary))], 0), " total abundance)")), 
          collapse = "\n"), "\n\n",
    "METABOLIC HIGHLIGHTS:\n",
    "- Energy metabolism pathways: ", sum(grepl("Energy|Fermentation|Respiration", category_summary$category)), "\n",
    "- Biosynthesis pathways: ", sum(grepl("Biosynthesis", category_summary$category)), "\n", 
    "- Degradation pathways: ", sum(grepl("Degradation", category_summary$category)), "\n"
  )
  
  writeLines(summary_text, "complete_functional_analysis/executive_summary.txt")
  
  cat("\n", paste(rep("=", 60), collapse = ""), "\n")
  cat("ANALYSIS COMPLETE!\n")
  cat(paste(rep("=", 60), collapse = ""), "\n")
  cat("Results exported to: complete_functional_analysis/\n\n")
  cat("Key outputs:\n")
  cat("- pathway_analysis_with_descriptions.csv: Complete pathway data\n")
  cat("- functional_category_summary.csv: Category-level analysis\n")
  cat("- executive_summary.txt: High-level summary\n") 
  cat("- High-quality plots showing functional capacity\n")
  cat("- Detailed CSV files for each functional category\n\n")
  
  cat("Your Cochliomyia macellaria endogenous microbiota shows:\n")
  cat("→ ", total_pathways, " distinct metabolic pathways\n")
  cat("→ ", nrow(category_summary), " major functional categories\n") 
  cat("→ ", universal_pathways, " universal pathways across all samples\n")
  cat("→ Dominated by: ", top_category, "\n")
  cat("→ Most abundant pathway: ", substr(top_pathway, 1, 80), "...\n")
}
